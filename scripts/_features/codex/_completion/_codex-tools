#compdef codex-tools cx
#
# Feature-gated: loaded only when `ZSH_FEATURES` includes `codex`.

_codex-tools() {
  emulate -L zsh -o extendedglob

  local context='' state='' state_descr=''
  local -a line=()
  typeset -A opt_args=()

  local -i orig_current="$CURRENT"
  local -a orig_words=("${words[@]}")

  typeset -a subcmds=()
  subcmds=(
    'commit-with-scope:Run semantic-commit skill (use -a/--auto-stage for semantic-commit-autostage)'
    'commit:Alias of commit-with-scope'
    'auto-refresh:Run codex-auto-refresh (token refresh helper)'
    'rate-limits:Run codex-rate-limits (supports --async for concurrent all-accounts table)'
    'advice:Get actionable engineering advice'
    'knowledge:Get clear explanation and angles for a concept'
    'prompt:Run a raw prompt'
    'help:Show usage'
    'list:Alias of help'
  )

  _arguments -C \
    '(-h --help)'{-h,--help}'[Show help]' \
    '1:command:->subcmds' \
    '*::arg:->args'

  case "${state-}" in
    subcmds)
      _describe -t commands 'codex-tools command' subcmds && return 0
      ;;
    args)
      local subcmd="${line[1]:-${orig_words[2]-}}"
      subcmd="${subcmd%%[[:space:]]#}"
      case "$subcmd" in
        commit-with-scope|commit)
          _arguments \
            '(-p)'{-p}'[Push to remote after commit]' \
            '(-a --auto-stage)'{-a,--auto-stage}'[Use semantic-commit-autostage (autostage all changes)]' \
            '*:prompt text:' && return 0
          return 0
          ;;
        auto-refresh)
          _message 'no args'
          return 0
          ;;
        rate-limits)
          _arguments -C \
            '(-h --help)'{-h,--help}'[Show help]' \
            '-c[Clear codex-starship cache before querying]' \
            '(-d --debug)'{-d,--debug}'[Keep stderr and show per-account errors]' \
            '--async[Use concurrent all-accounts mode (codex-rate-limits-async)]' \
            '(-j --jobs)'{-j,--jobs}'[Max concurrent requests (with --async)]:jobs count:' \
            '--cached[Use codex-starship cache (no network)]' \
            '--no-refresh-auth[Do not refresh auth tokens on HTTP 401]' \
            '--json[Print raw wham/usage JSON (single account only)]' \
            '--one-line[Print a single-line summary (single account only)]' \
            '--all[Query all secrets under CODEX_SECRET_DIR]' \
            '1::secret.json:->secrets'

          case "${state-}" in
            secrets)
              local secret_dir=''
              secret_dir="${CODEX_SECRET_DIR-}"
              if [[ -z "${secret_dir}" ]]; then
                secret_dir="${ZSH_SCRIPT_DIR-}/_features/codex/secrets"
              fi

              local -a secret_files=()
              if [[ -n "${secret_dir}" && -d "${secret_dir}" ]]; then
                secret_files=("${secret_dir}"/*.json(N))
              fi

              local -a secret_names=()
              local secret_file=''
              for secret_file in "${secret_files[@]}"; do
                secret_names+=("${secret_file:t}")
              done

              (( ${#secret_names[@]} )) && _values 'secret file' "${secret_names[@]}"
              return 0
              ;;
          esac

          return 0
          ;;
        advice)
          _message 'question'
          return 0
          ;;
        knowledge)
          _message 'concept'
          return 0
          ;;
        prompt|--)
          _message 'prompt'
          return 0
          ;;
        help|list)
          _message 'no args'
          return 0
          ;;
      esac
      ;;
  esac
}

compdef _codex-tools codex-tools cx

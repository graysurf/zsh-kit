#compdef git-scope

_git-scope() {
  emulate -L zsh -o extendedglob

  local context='' state='' state_descr=''
  local -a line=()
  typeset -A opt_args=()

  typeset -a subcommands=()
  subcommands=(
    'tracked:Show all tracked files (filtered by prefix, supports -p)'
    'staged:Show staged files (index contents, supports -p)'
    'unstaged:Show unstaged files (not yet staged, supports -p)'
    'all:Show all changed files (staged + unstaged, supports -p)'
    'untracked:Show untracked files (not added to Git, supports -p)'
    'commit:Inspect a specific commit (metadata, file list, and optionally file contents)'
    'help:Display help message for git-scope'
  )

  _arguments -C \
    '1:command:->subcmds' \
    '*::arg:->args'

  case "${state-}" in
    subcmds)
      _describe -t commands 'git-scope subcommand' subcommands && return 0
      ;;
    args)
      local subcmd="${line[1]-${words[2]-}}"

      case "$subcmd" in
        commit)
          _arguments -C \
            '(-p --print)'{-p,--print}'[Print contents of each file in the commit (from HEAD or working tree)]' \
            '2:commit hash:->commit_hashes'

          case "${state-}" in
            commit_hashes)
              local -a commit_hashes=()

              if command git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
                commit_hashes=(${(f)"$(command git log --pretty=format:'%h:%s' -n 20 2>/dev/null || true)"})
              fi

              if (( ${#commit_hashes[@]} > 0 )); then
                _describe -t commits 'commit hash' commit_hashes && return 0
              fi

              _message 'commit hash'
              return 0
              ;;
          esac

          return 0
          ;;
        tracked|staged|unstaged|all|untracked)
          _arguments -C \
            '(-p --print)'{-p,--print}'[Print the contents of each file]' \
            '2:prefix:_files -/' \
            '*:prefix:_files -/' \
            && return 0
          _message 'prefix'
          return 0
          ;;
      esac
      ;;
  esac
}

compdef _git-scope git-scope
